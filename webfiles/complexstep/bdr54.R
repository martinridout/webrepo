# -------------------------------------------------------------------
# Example 5.4 from Brazzale, Davison and # Reid (2007)
# Radioimmunoassay data. There are two replicates of each of 8 levels
# of drug concentration (x). The response (y) is the percentage of 
# radioactive gamma counts. There are 4 parameters (beta[1:4] 
# describing the mean response and 2 parameters gamma[1:2] for the
# variance (in addition to the scale factor sigma^2).
# So overall this is a 6-parameter nonlinear regression problem.
# -------------------------------------------------------------------

# Preliminaries
source("CStepDiff_functions.R")

# Data
x = rep(c(0,19.4,38.8,77.5,155.0,310.0,620.0,1240.0), each=2)
y = c(23.991, 24.973, 24.213, 24.769, 23.596, 24.800, 23.483, 23.770,
      19.504, 20.172, 14.242, 14.179, 7.030, 7.299, 3.624, 3.488)

# Negative log-likelihood function
# Parameters beta[5:6] are the parameters gamma[1:2] mentioned
# in the preamble.
# Coded to ensure that w^z = 0 when w=0 and z has non-zero
# imaginary part 
loglik <- function( beta, y, x) {
  mu = beta[1] + (beta[2]-beta[1]) / (1 + (x/beta[4]) ^ 
      (beta[3] * (x>0) + (x==0 & Re(beta[3]) > 0)))
  wt = mu^beta[5]
  sum( (y-mu)*(y-mu) / (2 * (beta[6]) * wt) + 
                      0.5 * (log(wt) + log(beta[6])))
}

# Parameter estimates
param = c(1.802, 24.575, 1.899, 334.956, 2.095, exp(-8.094))

# True observed information matrix, from high-precision calculations
# using MAPLE
truese = matrix( c(
.196816874386331274239769429599, -.402513119563683809366030206156, 
.909976600860891394246996163811, -.192123665432045178897238849952, 
.180009326296545764367708277240, -.175103699996695180664621673847, 
-.402513119563683809366030206156, .205493574761820455519312642706,
 -.535513263932020245233646582011, -.540265562572632296551266978691, 
-0.948059313982808533705260942973e-1, 0.874409142585676611783165499024e-1,
.909976600860891394246996163811, -.535513263932020245233646582011, 
0.741162389758848985064111199265e-1, .143620150765492549865289851418, 
.175875688555801634799614555557, -.170820256565046134118301172172, 
-.192123665432045178897238849952, -.540265562572632296551266978691,
 .143620150765492549865289851418, 5.76672914073797259424119406295, 
-0.633944990402153813757581223306e-2, 0.626676247850351395534029175476e-2, 
.180009326296545764367708277240, -0.948059313982808533705260942973e-1, 
.175875688555801634799614555557, -0.633944990402153813757581223306e-2, 
.521502845604103687050998268457, -.969933707199744163847011746855, 
-.175103699996695180664621673847, 0.874409142585676611783165499024e-1,
 -.170820256565046134118301172172, 0.626676247850351395534029175476e-2,
 -.969933707199744163847011746855, 0.443320454485617625090646778007e-3), 6, 6)

cc <- chkerrors(loglik, param, y, x, truese)
print(round(cc[2,],2))
